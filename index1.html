<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Digital Khata</title>
<style>
body{font-family:Arial}
input,select,button{margin:4px}
</style>
</head>
<body>

<h2>ðŸ“˜ Digital Khata</h2>

<div id="login">
  <input id="pin" placeholder="PIN">
  <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none">

<input id="customer" placeholder="Customer Name">
<select id="type">
  <option value="udhar">Udhar</option>
  <option value="jama">Jama</option>
</select>
<input id="amount" placeholder="Amount">
<input id="note" placeholder="Note">

<button onclick="add()">Save</button>
<button onclick="update()">Update</button>

<hr>

<button onclick="ledger()">Ledger</button>
<button onclick="balance()">Balance</button>
<button onclick="pdf()">PDF / WhatsApp</button>

<br>
<input type="date" id="from">
<input type="date" id="to">
<button onclick="filter()">Filter</button>

<pre id="out"></pre>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzGzC9tx7UIYf8RJIiglo_wlYa8r4ys9cnCjJKUFuveiVzRQGVKy5iFjcKSzF8x1Xn3/exec";
let editRow = null;

function login(){
  localStorage.pin = pin.value;
  login.style.display="none";
  app.style.display="block";
}

function add(){
  send("add");
}

function update(){
  if(!editRow) return alert("Select record first");
  send("update",{row:editRow});
  editRow=null;
}

function ledger(){
  fetch(API+"?"+qs({
    action:"ledger",
    pin:localStorage.pin,
    customer:customer.value
  }))
  .then(r=>r.json())
  .then(d=>{
    out.textContent="";
    d.forEach(x=>{
      out.textContent +=
       `Row:${x.row} ${x.r[1]} ${x.r[3]}\n`;
      editRow = x.row;
    });
  });
}

function balance(){
 fetch(API+"?"+qs({
  action:"balance",
  pin:localStorage.pin,
  customer:customer.value
 }))
 .then(r=>r.json())
 .then(d=>{
  out.textContent =
   `Opening: ${d.opening}
Udhar: ${d.udhar}
Jama: ${d.jama}
Balance: ${d.balance}`;
 });
}

function filter(){
 fetch(API+"?"+qs({
  action:"filter",
  pin:localStorage.pin,
  from:from.value,
  to:to.value
 }))
 .then(r=>r.json())
 .then(d=>out.textContent=JSON.stringify(d,null,2));
}

function pdf(){
 fetch(API+"?"+qs({
  action:"pdf",
  pin:localStorage.pin,
  customer:customer.value
 }))
 .then(r=>r.json())
 .then(d=>window.open(
  "https://wa.me/?text="+encodeURIComponent(d.url)
 ));
}

function send(action, extra={}){
 fetch(API+"?"+qs(Object.assign({
  action,
  pin:localStorage.pin,
  customer:customer.value,
  type:type.value,
  amount:amount.value,
  note:note.value
 },extra)))
 .then(r=>r.json())
 .then(()=>alert("Done"));
}

function qs(o){
 return new URLSearchParams(o).toString();
}
</script>

</body>
</html>
